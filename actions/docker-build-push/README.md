# Docker Build, Push, and Sign (Composite Action)

Builds a container image using Docker Buildx, generates tags/labels with `docker/metadata-action`, optionally pushes it, and keyless-signs pushed images with Cosign (OIDC).

## Requirements

- Grant `permissions: id-token: write` for keyless signing.
- Provide registry credentials via inputs `registry`, `username`, and `password` (login is mandatory).
- For GHCR, also grant `permissions: packages: write`. You may use `GITHUB_TOKEN` for `password` when pushing to GHCR in the same org.

If `push: 'true'` and the calling job lacks `permissions: id-token: write`, the action fails early with a clear error so you can fix permissions before the build proceeds.

## Inputs

- images: Newline-separated base image reference(s) (e.g., `ghcr.io/org/app`). Used by `docker/metadata-action` to generate tags. Required.
- push: Whether to push after build (enables SBOM, provenance, signing). Default `true`.
- build-args: Newline-separated `KEY=VALUE` build args. Optional.
- build-secrets: Newline-separated `KEY=VALUE` build secrets passed to Buildx as secrets. Values should reference caller secrets. Optional.
- annotations: Additional OCI annotations (newline-separated). Merged with `docker/metadata-action` output. Optional.
- labels: Additional labels (newline-separated). Merged with `docker/metadata-action` output. Optional.
- meta-tags: `docker/metadata-action` tag rules (newline-separated). Defaults include branch/PR/tag/semver/SHA. Optional.
- cache-image: Registry reference used by Buildx cache (e.g., `ghcr.io/org/app:buildcache-main`). Required.
- registry: Registry hostname for login (e.g., `ghcr.io`). Required.
- username: Registry username (GHCR: your GitHub username). Required.
- password: Registry password/token (GHCR: PAT or `GITHUB_TOKEN`). Required.

Signing runs only when `push` is `true` and a digest is produced; ensure `permissions: id-token: write`.

## Outputs

- digest: The image digest produced by Buildx.

## Usage

```yaml
permissions:
  contents: read
  id-token: write     # required for keyless signing
  packages: write     # required for GHCR pushes

jobs:
  build:
    runs-on: ubuntu-22.04-sh
    steps:
      - uses: actions/checkout@v5

      - name: Build, Push, and Sign
        # Pin to a tag or commit SHA in production for supply-chain security
        uses: Onemind-Services-LLC/actions/actions/docker-build-push@master
        with:
          images: |
            ghcr.io/acme/app
          push: 'true'
          build-args: |
            GIT_SHA=${{ github.sha }}
          build-secrets: |
            GIT_AUTH_TOKEN=${{ secrets.GIT_AUTH_TOKEN }}
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
          # Customize tag strategy (optional)
          meta-tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
          # Extra annotations (merged with metadata) (optional)
          annotations: |
            org.opencontainers.image.revision=${{ github.sha }}
            org.opencontainers.image.source=${{ github.repository }}
          # Buildx cache image reference (required)
          cache-image: ghcr.io/acme/app:buildcache-${{ github.ref_name }}
          # Signing runs automatically when push is true
```

Notes:
- If you set `push: 'false'`, signing and SBOM generation are skipped automatically.
- `images` must include full registry/repo paths (no tags); tags are generated by `docker/metadata-action`.
- Defaults derived internally:
  - Build context: `.` and Dockerfile: `Dockerfile`.
  - Labels/annotations come from `docker/metadata-action` with `DOCKER_METADATA_ANNOTATIONS_LEVELS=manifest,index`.
  - Added automatically (without hardcoding):
    - `org.opencontainers.image.authors=${{ github.repository_owner }}`
    - `org.opencontainers.image.vendor=${{ github.repository_owner }}`
    - `org.opencontainers.image.documentation=${{ github.server_url }}/${{ github.repository }}#readme`
    - `org.opencontainers.image.ref.name=${{ github.ref_name }}`
    These are emitted as both labels and annotations and merged with defaults and any user-supplied values.
  - SBOM is generated only when `push` is `true`.
  - Provenance is always enabled with `provenance: mode=max`.
  - Buildx cache uses the registry reference provided via `cache-image`:
    - `cache-from: type=registry,ref=<cache-image>,ignore-error=true`
    - `cache-to: type=registry,ref=<cache-image>,mode=max,ignore-error=true`

### Build Only (no push)

```yaml
permissions:
  contents: read

jobs:
  build-only:
    runs-on: ubuntu-22.04-sh
    steps:
      - uses: actions/checkout@v5
      - name: Build Only
        uses: Onemind-Services-LLC/actions/actions/docker-build-push@master
        with:
          images: ghcr.io/acme/app
          push: 'false'
          registry: ghcr.io
          username: dummy
          password: dummy
          cache-image: ghcr.io/acme/app:buildcache-${{ github.sha }}
```

Security tips:
- Pin third-party actions by version or commit SHA; avoid `@master` in production.
- Do not echo secrets; prefer using `secrets.GITHUB_TOKEN` for GHCR pushes when possible.
- Limit workflow permissions to the minimum required.
 - Prefer Buildx `secrets` over `build-args` for sensitive values. Access in Dockerfile via `RUN --mount=type=secret,id=GIT_AUTH_TOKEN`.
