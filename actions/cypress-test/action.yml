name: "Cypress Test"
description: "Run Cypress tests (component or e2e) with optional server start, waits, and artifact upload on failure"
inputs:
  node-version:
    description: Node.js version to use
    required: false
    default: '22.x'
  working-directory:
    description: Directory containing the project
    required: false
    default: '.'
  registry-url:
    description: Optional npm registry URL for scoped/private packages
    required: false
    default: ''
  registry-scope:
    description: Optional npm scope (e.g., '@your-scope') for auth
    required: false
    default: ''
  npm-token:
    description: NPM auth token for private registry access
    required: false
    default: ''
  browser:
    description: "Browser to run (chrome|edge|firefox)"
    required: true
  component:
    description: "Run in component test mode (false for e2e)"
    default: "true"
    required: false
  start:
    description: "Command to start the app/server for e2e"
    required: false
  wait-on:
    description: "URL(s) to wait on before running tests"
    required: false
  wait-on-timeout:
    description: "Timeout (seconds) for wait-on"
    required: false
    default: "300"
runs:
  using: "composite"
  steps:
    - name: Setup Node.js
      uses: Onemind-Services-LLC/actions/actions/npm-install-build@master
      with:
        node-version: ${{ inputs.node-version }}
        install: false
        build: false
        registry-url: ${{ inputs.registry-url }}
        scope: ${{ inputs.registry-scope }}
        always-auth: ${{ inputs.registry-url != '' }}

    - uses: browser-actions/setup-chrome@b94431e051d1c52dcbe9a7092a4f10f827795416 #v2.1.0
      if: ${{ inputs.browser == 'chrome' }}
      with:
        install-dependencies: true

    - uses: browser-actions/setup-firefox@5914774dda97099441f02628f8d46411fcfbd208 # v1.7.0
      if: ${{ inputs.browser == 'firefox' }}

    - uses: browser-actions/setup-edge@5a55d8fc0f012aa6e16b582df5bf9d6274bda7da # v1.1.1
      if: ${{ inputs.browser == 'edge' }}

    - name: Run Cypress tests
      uses: cypress-io/github-action@b8ba51a856ba5f4c15cf39007636d4ab04f23e3c # v6.10.2
      with:
        component: ${{ inputs.component }}
        install: true
        browser: ${{ inputs.browser }}
        start: ${{ inputs.start }}
        wait-on: ${{ inputs.wait-on }}
        wait-on-timeout: ${{ inputs.wait-on-timeout }}
        working-directory: ${{ inputs.working-directory }}
      env:
        FORCE_FIREFOX_CDP: ${{ inputs.browser == 'firefox' && '1' || '' }}

    - name: Upload screenshots on failure
      if: ${{ failure() }}
      uses: actions/upload-artifact@v4
      with:
        name: cypress-screenshots-${{ inputs.browser }}
        path: cypress/screenshots
        if-no-files-found: ignore
