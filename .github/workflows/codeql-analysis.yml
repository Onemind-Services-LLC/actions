name: CodeQL Analysis

on:
  workflow_call:
    inputs:
      runs-on:
        description: Runner label
        required: false
        default: ubuntu-22.04-sh
        type: string
      app-id:
        description: GitHub App ID for generating installation token (falls back to vars.APP_ID if omitted)
        required: false
        type: string
      languages:
        description: Comma-separated CodeQL languages (e.g., 'javascript-typescript,python,go')
        required: false
        default: javascript-typescript,python
        type: string
      source-root:
        description: Directory to analyze (source root)
        required: false
        default: '.'
        type: string
      build-mode:
        description: 'Build mode for single-language jobs: "none", "autobuild", or "manual"'
        required: false
        default: autobuild
        type: string
      build-command:
        description: Manual build command when build-mode is 'manual'
        required: false
        default: ''
        type: string
      queries:
        description: CodeQL queries or packs (e.g., 'security-extended' or '+security-and-quality')
        required: false
        default: ''
        type: string
      packs:
        description: Comma-separated list of CodeQL packs to run (single-language only). Prefix with '+' to merge.
        required: false
        default: ''
        type: string
      config-file:
        description: Path to a CodeQL config file (e.g., .github/codeql/codeql-config.yml)
        required: false
        default: ''
        type: string
      tools:
        description: Override CodeQL bundle (path/URL or 'linked')
        required: false
        default: ''
        type: string
    secrets:
      private-key:
        description: GitHub App private key (PEM) used to mint installation tokens
        required: false

permissions:
  contents: read
  actions: read
  security-events: write

jobs:
  analyze:
    name: CodeQL Analyze
    runs-on: ${{ inputs.runs-on }}
    defaults:
      run:
        shell: bash
        working-directory: ${{ inputs.source-root }}
    steps:
      - name: Create App Token
        id: repo-token
        uses: Onemind-Services-LLC/actions/actions/create-repo-token@master
        with:
          app-id: ${{ inputs.app-id }}
          private-key: ${{ secrets.private-key }}
          owner: Onemind-Services-LLC
          github-token: ${{ github.actor == 'dependabot[bot]' && github.token || '' }}

      - name: Checkout
        uses: actions/checkout@v5

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: ${{ inputs.languages }}
          source-root: ${{ inputs.source-root }}
          queries: ${{ inputs.queries }}
          packs: ${{ inputs.packs }}
          config-file: ${{ inputs.config-file }}
          tools: ${{ inputs.tools }}

      - name: Autobuild
        if: inputs.build-mode == 'autobuild'
        uses: github/codeql-action/autobuild@v3

      - name: Manual Build
        if: inputs.build-mode == 'manual' && inputs.build-command != ''
        run: ${{ inputs.build-command }}

      - name: Analyze
        uses: github/codeql-action/analyze@v3
